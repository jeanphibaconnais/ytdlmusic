name: 'Full Test'
description: 'Full Test for ytdlmusic'
inputs:
  who-to-greet:
    description: 'Who to greet'
    required: true
    default: 'World'
runs:
  using: "composite"
  steps:
    - name: test 'ytdlmusic'   
      shell: bash      
      run: |
        ytdlmusic
        ytdlmusic | grep "SYNOPSIS"
        ytdlmusic | grep "ytdlmusic version             :"                   
    - name: test 'ytdlmusic --version'
      shell: bash 
      run: |
        ytdlmusic --version
        ytdlmusic --version | grep "ytdlmusic version             :"
    - name: test 'ytdlmusic --help'
      shell: bash
      run: |
        ytdlmusic --help
        ytdlmusic --help | grep "SYNOPSIS"  
    - name: test 'ytdlmusic --auto artist title'
      shell: bash
      run: |
        ytdlmusic -f --auto "Rexlambo" "Stay With Me"
        test -f rexlambo_stay_with_me_1.m4a          
    - name: test 'ytdlmusic artist title' interactive mode
      shell: bash
      run: |          
        printf '3\n' | ytdlmusic -f --n=4 "Rexlambo" "Stay With Me" | grep "1-4" | wc -l | grep 1
        test -f rexlambo_stay_with_me_2.m4a
    - name: test 'ytdlmusic --auto artist title' with ffmpeg
      shell: bash
      run: |          
        ytdlmusic --auto "Rexlambo" "Stay With Me"
        test -f rexlambo_stay_with_me.mp3
        file -b rexlambo_stay_with_me.mp3 | grep "Audio file with ID3 version 2.4.0, contains:MPEG ADTS, layer III, v1, 256 kbps, 48 kHz, Stereo"
    - name: test 'ytdlmusic --auto artist title' with ffmpeg force ogg
      shell: bash
      run: |          
        ytdlmusic -yo "Rexlambo" "Stay With Me"
        test -f rexlambo_stay_with_me.ogg
        file -b rexlambo_stay_with_me.ogg | grep -b "Ogg data, Vorbis audio, stereo, 48000 Hz, ~112000 bps"                               
    - name: test downloaded files
      shell: bash
      run: |          
        md5sum rexlambo_stay_with_me.m4a
        md5sum rexlambo_stay_with_me_1.m4a
        echo "les md5 doivent etre differents"
        test "$(md5sum rexlambo_stay_with_me.m4a)" != "$(md5sum rexlambo_stay_with_me_1.m4a)"
    - name: test 'ytdlmusic --auto artist title' with force m4a
      shell: bash
      run: |          
        ytdlmusic --auto --m4a "Rexlambo" "Stay With Me"
        test -f rexlambo_stay_with_me_2.m4a       
    - name: test batch
      shell: bash
      run: |
        echo "launch batch and verify three downloads"
        ytdlmusic --auto --batch="./test/test.csv"%True%";"%2%1 | grep "is ready" | wc -l | grep 3
        test -f above_limujii.mp3
        test -f awake_nomyn.mp3
        test -f avalon_scandinavianz.mp3
    - name: test bad launch
      shell: bash
      run: |          
        (ytdlmusic --tetet || echo "good exit code") | grep "good exit code"
        (ytdlmusic --tetet || echo "good exit code") | grep "Not recognized option"
    - name: test short params
      shell: bash
      run: |          
        ytdlmusic -fyd "Rexlambo" "Stay With Me"
        test -f rexlambo_stay_with_me_3.m4a  
    - name: test bad launch short params
      shell: bash
      run: |          
        (ytdlmusic -dvUz || echo "good exit code") | grep "good exit code"
        (ytdlmusic -dvUz || echo "good exit code") | grep "Not recognized option"      
    - name: test missing dependency error
      shell: bash
      run: |          
        pip uninstall --yes youtube-dl
        ytdlmusic --version | grep "youtube-dl version            : NOT INSTALLED"
        (ytdlmusic --auto "Rexlambo" "Stay With Me" || echo "good exit code") | grep "good exit code"
        (ytdlmusic --auto "Rexlambo" "Stay With Me" || echo "good exit code") | grep "Try to upgrade with 'ytdlmusic --update'"
    - name: test repair full-update
      shell: bash
      run: |               
        printf 'y\n' | ytdlmusic --full-update | grep "Update available"
        ytdlmusic --auto -q "Rexlambo" "Stay With Me" | grep "ffmpeg" || echo "lof ffmpeg non trouve") | grep "good exit code"
        ytdlmusic -dkQ --auto "Rexlambo" "Stay With Me" | grep "320"
        test -f avalon_scandinavianz_no_copyright_music_.mp3
        printf 'y\n' | ytdlmusic --full-update | grep "No update available"
    - name: test bad launch (one parameter)
      shell: bash
      run: |          
        (ytdlmusic --tetet || echo "good exit code") | grep "good exit code"
        (ytdlmusic --tetet || echo "good exit code") | grep "Missing song"            